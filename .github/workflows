name: Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Build and Push Docker image
        run: |
          # Build Docker image
          docker build -t my-app .
          
          # Authenticate with the container registry
          docker login -u USERNAME -p PASSWORD CONTAINER_REGISTRY

          # Tag the Docker image
          docker tag my-app CONTAINER_REGISTRY/USERNAME/my-app:latest

          # Push the Docker image to the container registry
          docker push CONTAINER_REGISTRY/USERNAME/my-app:latest

      - name: Deploy to target VM
        run: |
          # Connect to the target VM and deploy the app using SSH
          ssh USER@TARGET_VM 'docker-compose pull && docker-compose up -d'
